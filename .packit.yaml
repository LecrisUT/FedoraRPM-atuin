_:
  - &trigger
    trigger: commit
    branch: main
  - &actions-use-spec
    fix-spec-file: []
    create-archive:
      - sh -c 'echo ${PACKIT_DOWNSTREAM_PACKAGE_NAME}.spec'
    get-current-version:
      - sh -c 'rpmspec -q --qf "%{Version}" --srpm ${PACKIT_DOWNSTREAM_PACKAGE_NAME}.spec'
  - &actions-rust2rpm
    <<: *actions-use-spec
    fix-spec-file:
      - sh -c 'rust2rpm @${PACKIT_PROJECT_VERSION}'
  - &actions-rust2rpm-with-patch
    <<: *actions-use-spec
    fix-spec-file:
      - sh -c 'rust2rpm -r @${PACKIT_PROJECT_VERSION}'

packages:
  atuin:
    paths: [ atuin ]
    specfile_path: atuin.spec
    downstream_package_name: atuin
    upstream_package_name: atuin
    actions: *actions-use-spec
  rust-metrics-exporter-prometheus:
    paths: [ rust-metrics-exporter-prometheus ]
    specfile_path: rust-metrics-exporter-prometheus.spec
    downstream_package_name: rust-metrics-exporter-prometheus
    upstream_package_name: metrics-exporter-prometheus
    actions: *actions-rust2rpm-with-patch
  rust-prost:
    paths: [ rust-prost ]
    specfile_path: rust-prost.spec
    downstream_package_name: rust-prost
    upstream_package_name: prost
    actions: *actions-rust2rpm-with-patch
  rust-prost-build:
    paths: [ rust-prost-build ]
    specfile_path: rust-prost-build.spec
    downstream_package_name: rust-prost-build
    upstream_package_name: prost-build
    actions: *actions-rust2rpm
  rust-prost-types:
    paths: [ rust-prost-types ]
    specfile_path: rust-prost-types.spec
    downstream_package_name: rust-prost-types
    upstream_package_name: prost-types
    actions: *actions-rust2rpm
  rust-prost-derive:
    paths: [ rust-prost-derive ]
    specfile_path: rust-prost-derive.spec
    downstream_package_name: rust-prost-derive
    upstream_package_name: prost-derive
    actions: *actions-rust2rpm

srpm_build_deps:
  - rust2rpm
  - rust2rpm-helper

targets:
  - fedora-rawhide
  - epel9

jobs:
  - job: copr_build
    owner: lecris
    project: atuin
    <<: *trigger
  - job: tests
    <<: *trigger
